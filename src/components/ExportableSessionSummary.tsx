import React, { useMemo } from 'react';
import {
  Box,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Divider,
  Chip,
  Avatar,
} from '@mui/material';
import {
  Event,
  LocationOn,
  AccessTime,
  Person,
  QrCode2,
  CheckCircle,
  Cancel,
} from '@mui/icons-material';
import { formatCurrency, formatDate, formatTime, calculateMemberSettlement, convertTimestampToDate } from '../utils';
import { Session } from '../types';

interface ExportableSessionSummaryProps {
  session: Session;
  members: { id: string; name: string }[];
  courtName?: string;
}

const ExportableSessionSummary: React.FC<ExportableSessionSummaryProps> = ({
  session,
  members,
  courtName,
}) => {
  // ‚úÖ CHUY·ªÇN ƒê·ªîI DATE AN TO√ÄN TR∆Ø·ªöC KHI RENDER
  const safeDate = convertTimestampToDate(session.date);
  const formattedDate = safeDate ? formatDate(safeDate) : 'Ng√†y kh√¥ng x√°c ƒë·ªãnh';
  // ===== LOGIC M·ªöI: L·∫•y t·∫•t c·∫£ th√†nh vi√™n li√™n quan =====
  const presentMembers = session.members.filter(m => m.isPresent);
  
  // L·∫•y danh s√°ch c√°c kho·∫£n chi b·ªï sung
  const additionalExpenses = useMemo(() => {
    return session.expenses.filter(exp => exp.type === 'other');
  }, [session.expenses]);

  // L·∫•y t·∫•t c·∫£ memberIds t·ª´ chi ph√≠ b·ªï sung
  const membersWithAdditionalExpenses = useMemo(() => {
    const memberIds = new Set<string>();
    additionalExpenses.forEach(expense => {
      if (expense.memberIds && expense.memberIds.length > 0) {
        expense.memberIds.forEach(memberId => memberIds.add(memberId));
      }
    });
    return memberIds;
  }, [additionalExpenses]);
  
  // K·∫øt h·ª£p: th√†nh vi√™n c√≥ m·∫∑t + th√†nh vi√™n c√≥ chi ph√≠ b·ªï sung
  const allRelevantMemberIds = useMemo(() => {
    return new Set([
      ...presentMembers.map(m => m.memberId),
      ...Array.from(membersWithAdditionalExpenses)
    ]);
  }, [presentMembers, membersWithAdditionalExpenses]);

  // L·∫•y danh s√°ch session members li√™n quan
  const relevantMembers = useMemo(() => {
    return session.members.filter(m => allRelevantMemberIds.has(m.memberId));
  }, [session.members, allRelevantMemberIds]);

  // T√≠nh to√°n chi ti·∫øt cho t·ª´ng th√†nh vi√™n
  const memberPayments = useMemo(() => {
    return relevantMembers.map(sessionMember => {
      const member = members.find(m => m.id === sessionMember.memberId);
      const settlement = calculateMemberSettlement(session, sessionMember.memberId, members);
      
      // T·∫°o map c√°c kho·∫£n b·ªï sung cho th√†nh vi√™n n√†y
      const additionalCostsMap = new Map<string, number>();
      settlement.additionalCosts.forEach(cost => {
        additionalCostsMap.set(cost.name, cost.amount);
      });

      return {
        id: sessionMember.memberId,
        name: sessionMember.memberName || member?.name || 'Unknown',
        isPresent: sessionMember.isPresent,
        baseCost: settlement.baseCost,
        additionalCostsMap,
        total: settlement.total,
        isPaid: session.settlements?.find(s => s.memberId === sessionMember.memberId)?.isPaid || false,
        replacementNote: sessionMember.replacementNote,
      };
    });
  }, [relevantMembers, session, members]);

  const totalBaseCost = memberPayments.reduce((sum, m) => sum + m.baseCost, 0);
  const grandTotal = memberPayments.reduce((sum, m) => sum + m.total, 0);

  // T√≠nh t·ªïng cho t·ª´ng c·ªôt chi ph√≠ b·ªï sung
  const additionalColumnTotals = useMemo(() => {
    const totals = new Map<string, number>();
    additionalExpenses.forEach(expense => {
      let total = 0;
      memberPayments.forEach(payment => {
        total += payment.additionalCostsMap.get(expense.name) || 0;
      });
      totals.set(expense.name, total);
    });
    return totals;
  }, [additionalExpenses, memberPayments]);

  return (
    <Box
      sx={{
        width: '100%',
        maxWidth: '1200px',
        backgroundColor: 'white',
        p: 4,
        fontFamily: 'Arial, sans-serif',
      }}
    >
      {/* Header */}
      <Box sx={{ textAlign: 'center', mb: 3, pb: 2, borderBottom: '3px solid #2196f3' }}>
        <Typography variant="h4" fontWeight="bold" color="primary.main" gutterBottom>
          {session.name}
        </Typography>
        <Typography variant="subtitle1" color="text.dark">
          Danh s√°ch thanh to√°n
        </Typography>
      </Box>

      {/* Info Grid */}
      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 3, mb: 3 }}>
        {/* Left Column */}
        <Box>
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5 }}>
            <LocationOn sx={{ mr: 1, color: 'primary.main', fontSize: 20 }} />
            <Typography variant="body1" color="#000000">
              <strong>S√¢n:</strong> {courtName || 'Ch∆∞a x√°c ƒë·ªãnh'}
            </Typography>
          </Box>
          
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5 }}>
            <Event sx={{ mr: 1, color: 'primary.main', fontSize: 20 }} />
            <Typography variant="body1" color="#000000">
              <strong>Ng√†y:</strong> {formattedDate}
            </Typography>
          </Box>
          
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5 }}>
            <AccessTime sx={{ mr: 1, color: 'primary.main', fontSize: 20 }} />
            <Typography variant="body1" color="#000000">
              <strong>Gi·ªù:</strong> {formatTime(session.startTime)} - {formatTime(session.endTime)}
            </Typography>
          </Box>
        </Box> 

        {/* Right Column */}
        <Box>
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5 }}>
            <Person sx={{ mr: 1, color: 'success.main', fontSize: 20 }} />
            <Typography variant="body1" color="#000000">
              <strong>Host:</strong> {session.host?.name || 'Ch∆∞a x√°c ƒë·ªãnh'}
            </Typography>
          </Box>
          
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5, color: '#000000' }}>
            <Typography variant="body1">
              <strong>T·ªïng chi ph√≠:</strong> <span style={{ color: '#2196f3', fontWeight: 'bold' }}>{formatCurrency(session.totalCost)}</span>
            </Typography>
          </Box>
          
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 1.5, color: '#000000' }}>
            <Typography variant="body1" color="#000000">
              <strong>C√≥ m·∫∑t:</strong> {presentMembers.length} / {memberPayments.length} ng∆∞·ªùi
            </Typography>
          </Box>
        </Box>
      </Box>

      <Divider sx={{ my: 2 }} />

      {/* Payment Table */}
      <Box sx={{ mb: 3 }}>
        <Typography variant="h6" fontWeight="bold" gutterBottom sx={{ mb: 2, color: '#000000' }}>
          Chi ti·∫øt thanh to√°n t·ª´ng th√†nh vi√™n
        </Typography>
        
        <TableContainer component={Paper} variant="outlined">
          <Table size="small">
            <TableHead>
              <TableRow sx={{ backgroundColor: '#f5f5f5' }}>
                <TableCell sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  Th√†nh vi√™n
                </TableCell>
                <TableCell align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  S√¢n + C·∫ßu
                </TableCell>
                
                {/* C√°c c·ªôt chi ph√≠ b·ªï sung */}
                {additionalExpenses.map(expense => (
                  <TableCell key={expense.id} align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                    {expense.name}
                  </TableCell>
                ))}
                
                <TableCell align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  T·ªïng c·ªông
                </TableCell>
                <TableCell align="center" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  Thanh to√°n
                </TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {memberPayments.map((payment) => (
                <TableRow key={payment.id}>
                  <TableCell sx={{ border: '1px solid #ddd' }}>
                    <Box sx={{ display: 'flex', alignItems: 'center' }}>
                      <Avatar sx={{ mr: 1, width: 28, height: 28, fontSize: '0.9rem', color: '#ffffffff' }}>
                        {payment.name.charAt(0).toUpperCase()}
                      </Avatar>
                      <Box>
                        <Typography variant="body2" fontWeight="medium" color="#ffffffff">
                          {payment.name}
                        </Typography>
                        {/* Ghi ch√∫ thay th·∫ø */}
                        {payment.replacementNote && (
                          <Typography 
                            variant="caption" 
                            color="info.main"
                            sx={{ 
                              display: 'block', 
                              fontStyle: 'italic',
                              mt: 0.3,
                              fontSize: '0.7rem'
                            }}
                          >
                            üîÑ {payment.replacementNote}
                          </Typography>
                        )}
                      </Box>
                    </Box>
                  </TableCell>
                  
                  <TableCell align="right" sx={{ border: '1px solid #ddd', color: '#30ff06ff' }}>
                    {formatCurrency(payment.baseCost)}
                  </TableCell>
                  
                  {/* C√°c c·ªôt chi ph√≠ b·ªï sung */}
                  {additionalExpenses.map(expense => {
                    const amount = payment.additionalCostsMap.get(expense.name);
                    return (
                      <TableCell 
                        key={expense.id} 
                        align="right" 
                        sx={{ border: '1px solid #ddd', color: '#30ff06ff' }}
                      >
                        {amount ? formatCurrency(amount) : '-'}
                      </TableCell>
                    );
                  })}
                  
                  <TableCell align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#2196f3' }}>
                    {formatCurrency(payment.total)}
                  </TableCell>
                  
                  <TableCell align="center" sx={{ border: '1px solid #ddd' }}>
                    {payment.isPaid ? (
                      <CheckCircle sx={{ color: '#4caf50', fontSize: 20 }} />
                    ) : (
                      <Cancel sx={{ color: '#f44336', fontSize: 20 }} />
                    )}
                  </TableCell>
                </TableRow>
              ))}
              
              {/* D√≤ng t·ªïng */}
              <TableRow sx={{ backgroundColor: '#e3f2fd' }}>
                <TableCell sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  T·ªîNG C·ªòNG ({memberPayments.length} ng∆∞·ªùi)
                </TableCell>
                
                <TableCell align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                  {formatCurrency(totalBaseCost)}
                </TableCell>
                
                {additionalExpenses.map(expense => {
                  const total = additionalColumnTotals.get(expense.name) || 0;
                  return (
                    <TableCell key={expense.id} align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#000000' }}>
                      {formatCurrency(total)}
                    </TableCell>
                  );
                })}
                
                <TableCell align="right" sx={{ fontWeight: 'bold', border: '1px solid #ddd', color: '#2196f3', fontSize: '1.1rem' }}>
                  {formatCurrency(grandTotal)}
                </TableCell>
                
                <TableCell align="center" sx={{ border: '1px solid #ddd' }}>
                  <Typography variant="caption" fontWeight="bold" color="info.main">
                    {memberPayments.filter(m => m.isPaid).length}/{memberPayments.length}
                  </Typography>
                </TableCell>
              </TableRow>
            </TableBody>
          </Table>
        </TableContainer>
      </Box>

      {/* Ghi ch√∫ quan tr·ªçng */}
      <Box sx={{ mb: 3, p: 2, backgroundColor: '#fff3e0', borderRadius: 1, border: '1px solid #ffb74d' }}>
        <Typography variant="body2" color="#000000">
          üí° <strong>Ghi ch√∫:</strong> Danh s√°ch bao g·ªìm c·∫£ th√†nh vi√™n v·∫Øng m·∫∑t nh∆∞ng c√≥ chi ph√≠ b·ªï sung c·∫ßn thanh to√°n.
          Ti·ªÅn s√¢n + c·∫ßu ch·ªâ ƒë∆∞·ª£c t√≠nh cho th√†nh vi√™n c√≥ m·∫∑t.
        </Typography>
      </Box>

      {/* QR Code Section */}
      {session.qrImage && (
        <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexDirection: 'column', mt: 3 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
            <QrCode2 sx={{ mr: 1, color: 'success.main' }} />
            <Typography variant="h6" fontWeight="bold" color="#000000">
              Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
            </Typography>
          </Box>
          <Box
            sx={{
              border: '3px solid #4caf50',
              borderRadius: 2,
              p: 2,
              backgroundColor: '#f1f8f4',
            }}
          >
            <img
              src={session.qrImage}
              alt="QR Code"
              style={{
                width: '250px',
                height: '250px',
                objectFit: 'contain',
              }}
            />
          </Box>
          <Typography variant="caption" color="success.main" sx={{ mt: 1 }}>
            Chuy·ªÉn kho·∫£n cho: <strong>{session.host?.name || 'Ng∆∞·ªùi t·ªï ch·ª©c'}</strong>
          </Typography>
        </Box>
      )}

      {/* Footer */}
      <Box sx={{ mt: 4, pt: 2, borderTop: '1px solid #ddd', textAlign: 'center' }}>
        <Typography variant="caption" color="text.secondary">
          üìù S√¢n + C·∫ßu chia ƒë·ªÅu cho ng∆∞·ªùi c√≥ m·∫∑t. Chi ph√≠ b·ªï sung ch·ªâ t√≠nh cho ng∆∞·ªùi tham gia.
        </Typography>
        <Typography variant="caption" color="text.secondary" display="block" sx={{ mt: 0.5 }}>
          ƒê∆∞·ª£c t·∫°o b·ªüi: {session.host?.name || 'H·ªá th·ªëng'} ‚Ä¢ {formatDate(new Date())}
        </Typography>
      </Box>
    </Box>
  );
};

export default ExportableSessionSummary;