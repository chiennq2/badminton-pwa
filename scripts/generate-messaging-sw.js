// scripts/generate-messaging-sw.js
import { writeFileSync, existsSync, mkdirSync } from 'fs';
import { resolve, dirname } from 'path';
import { config } from 'dotenv';
import { fileURLToPath } from 'url';
import path from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load .env file
config({ path: resolve(__dirname, '../.env') });

console.log('\nüî• Manual Firebase Messaging SW Generator\n');

const env = process.env;
const envPrefix = 'VITE_';

// Required env vars
const requiredVars = [
  `${envPrefix}FIREBASE_API_KEY`,
  `${envPrefix}FIREBASE_AUTH_DOMAIN`,
  `${envPrefix}FIREBASE_PROJECT_ID`,
  `${envPrefix}FIREBASE_STORAGE_BUCKET`,
  `${envPrefix}FIREBASE_MESSAGING_SENDER_ID`,
  `${envPrefix}FIREBASE_APP_ID`,
];

// Check for missing vars
const missingVars = requiredVars.filter(varName => !env[varName]);

if (missingVars.length > 0) {
  console.error('‚ùå Missing Firebase environment variables:');
  missingVars.forEach(varName => {
    console.error(`   - ${varName}`);
  });
  console.error('\nüí° Please check your .env file\n');
  process.exit(1);
}

console.log('‚úÖ All Firebase environment variables found\n');

// Show config (masked)
console.log('üìã Firebase Configuration:');
console.log(`   - API Key: ${env[`${envPrefix}FIREBASE_API_KEY`]?.substring(0, 10)}...`);
console.log(`   - Auth Domain: ${env[`${envPrefix}FIREBASE_AUTH_DOMAIN`]}`);
console.log(`   - Project ID: ${env[`${envPrefix}FIREBASE_PROJECT_ID`]}`);
console.log(`   - Storage Bucket: ${env[`${envPrefix}FIREBASE_STORAGE_BUCKET`]}`);
console.log(`   - Sender ID: ${env[`${envPrefix}FIREBASE_MESSAGING_SENDER_ID`]}`);
console.log(`   - App ID: ${env[`${envPrefix}FIREBASE_APP_ID`]?.substring(0, 20)}...`);
console.log();

const swContent = `// firebase-messaging-sw.js
// Auto-generated by vite-plugin-firebase-messaging-sw
// Generated at: ${new Date().toISOString()}

importScripts('https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js');

console.log('[FCM-SW] Firebase Messaging Service Worker loaded');

// Firebase Configuration
const firebaseConfig = {
  apiKey: "${env[`${envPrefix}FIREBASE_API_KEY`]}",
  authDomain: "${env[`${envPrefix}FIREBASE_AUTH_DOMAIN`]}",
  projectId: "${env[`${envPrefix}FIREBASE_PROJECT_ID`]}",
  storageBucket: "${env[`${envPrefix}FIREBASE_STORAGE_BUCKET`]}",
  messagingSenderId: "${env[`${envPrefix}FIREBASE_MESSAGING_SENDER_ID`]}",
  appId: "${env[`${envPrefix}FIREBASE_APP_ID`]}"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();
  console.log('[FCM-SW] Firebase initialized successfully');

  // Handle background messages
  messaging.onBackgroundMessage((payload) => {
    console.log('[FCM-SW] Received background message:', payload);

    const notificationTitle = payload.notification?.title || 'Th√¥ng b√°o m·ªõi';
    const notificationOptions = {
      body: payload.notification?.body || '',
      icon: payload.notification?.icon || '/favicon.ico',
      badge: '/pwa-192x192.png',
      vibrate: [200, 100, 200],
      data: {
        url: payload.data?.url || '/',
        dateOfArrival: Date.now(),
        ...payload.data,
      },
      actions: [
        {
          action: 'open',
          title: 'M·ªü ·ª©ng d·ª•ng',
        },
        {
          action: 'close',
          title: 'ƒê√≥ng',
        }
      ],
      tag: payload.data?.tag || 'notification',
      requireInteraction: false,
      silent: false,
    };

    return self.registration.showNotification(notificationTitle, notificationOptions);
  });

  // Handle notification click
  self.addEventListener('notificationclick', (event) => {
    console.log('[FCM-SW] Notification click:', event.action);
    
    event.notification.close();

    if (event.action === 'close') {
      return;
    }

    if (event.action === 'open' || !event.action) {
      const urlToOpen = event.notification.data?.url || '/';
      
      event.waitUntil(
        clients.matchAll({ 
          type: 'window', 
          includeUncontrolled: true 
        }).then((windowClients) => {
          for (const client of windowClients) {
            try {
              const clientUrl = new URL(client.url);
              const targetUrl = new URL(urlToOpen, self.location.origin);
              
              if (clientUrl.origin === targetUrl.origin && 'focus' in client) {
                if (clientUrl.pathname !== targetUrl.pathname) {
                  return client.navigate(urlToOpen).then(c => c ? c.focus() : null);
                }
                return client.focus();
              }
            } catch (e) {
              console.error('[FCM-SW] Error processing client:', e);
            }
          }
          
          if (clients.openWindow) {
            return clients.openWindow(urlToOpen);
          }
        }).catch(err => {
          console.error('[FCM-SW] Error handling notification click:', err);
        })
      );
    }
  });

  // Handle push events (fallback)
  self.addEventListener('push', (event) => {
    console.log('[FCM-SW] Push event received');
    
    if (!event.data) {
      console.log('[FCM-SW] Push event has no data');
      return;
    }

    try {
      const payload = event.data.json();
      console.log('[FCM-SW] Push payload:', payload);

      const notificationTitle = payload.notification?.title || payload.data?.title || 'Th√¥ng b√°o m·ªõi';
      const notificationOptions = {
        body: payload.notification?.body || payload.data?.body || '',
        icon: payload.notification?.icon || '/favicon.ico',
        badge: '/pwa-192x192.png',
        vibrate: [200, 100, 200],
        data: payload.data || {},
        tag: payload.data?.tag || 'push-notification',
        requireInteraction: false,
      };

      event.waitUntil(
        self.registration.showNotification(notificationTitle, notificationOptions)
      );
    } catch (error) {
      console.error('[FCM-SW] Error parsing push data:', error);
    }
  });

} catch (error) {
  console.error('[FCM-SW] Error initializing Firebase:', error);
}
`;

// Output path
const outputPath = resolve(__dirname, '../public/firebase-messaging-sw.js');
const outputDir = dirname(outputPath);

try {
  // Create public directory if not exists
  if (!existsSync(outputDir)) {
    mkdirSync(outputDir, { recursive: true });
    console.log('üìÅ Created public directory');
  }

  // Write file
  writeFileSync(outputPath, swContent, 'utf-8');
  console.log('‚úÖ firebase-messaging-sw.js generated successfully!');
  console.log(`üìÑ Location: ${outputPath}`);
  console.log('\n‚ú® Done! You can now run your dev server.\n');
} catch (error) {
  console.error('‚ùå Error generating firebase-messaging-sw.js:', error);
  process.exit(1);
}